{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">印刷订单仪表板</h3>
                    <div class="panel-actions">
                        <a href="{% url 'print_order_list' %}" class="btn btn-primary">订单列表</a>
                        <a href="{% url 'create_print_order' %}" class="btn btn-success">创建订单</a>
                    </div>
                </div>
                <div class="panel-body">
                    <!-- 统计卡片 -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card bg-primary">
                                <div class="stat-icon">
                                    <i class="fa fa-list"></i>
                                </div>
                                <div class="stat-content">
                                    <h3>{{ total_orders }}</h3>
                                    <p>总订单数</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-warning">
                                <div class="stat-icon">
                                    <i class="fa fa-clock-o"></i>
                                </div>
                                <div class="stat-content">
                                    <h3>{{ pending_orders }}</h3>
                                    <p>待处理订单</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-info">
                                <div class="stat-icon">
                                    <i class="fa fa-cogs"></i>
                                </div>
                                <div class="stat-content">
                                    <h3>{{ processing_orders }}</h3>
                                    <p>处理中订单</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-success">
                                <div class="stat-icon">
                                    <i class="fa fa-check"></i>
                                </div>
                                <div class="stat-content">
                                    <h3>{{ completed_orders }}</h3>
                                    <p>已完成订单</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 最近订单 -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4>
                                        {{ current_filter_name }}
                                        <small>(共 {{ recent_orders|length }} 条)</small>
                                    </h4>
                                    <div class="panel-actions">
                                        <div class="btn-group" role="group">
                                            <a href="?status=all" class="btn btn-sm {% if status_filter == 'all' %}btn-primary{% else %}btn-default{% endif %}">
                                                全部 ({{ total_orders }})
                                            </a>
                                            <a href="?status=pending" class="btn btn-sm {% if status_filter == 'pending' %}btn-warning{% else %}btn-default{% endif %}">
                                                待处理 ({{ pending_orders }})
                                            </a>
                                            <a href="?status=processing" class="btn btn-sm {% if status_filter == 'processing' %}btn-info{% else %}btn-default{% endif %}">
                                                处理中 ({{ processing_orders }})
                                            </a>
                                            <a href="?status=completed" class="btn btn-sm {% if status_filter == 'completed' %}btn-success{% else %}btn-default{% endif %}">
                                                已完成 ({{ completed_orders }})
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel-body">
                                    {% if recent_orders %}
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>订单编号</th>
                                                    <th>客户名称</th>
                                                    <th>产品名称</th>
                                                    <th>状态 / 当前步骤</th>
                                                    <th>进度</th>
                                                    <th>下单日期</th>
                                                    <th>交货日期</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for order_info in recent_orders %}
                                                <tr>
                                                    <td>
                                                        <strong>{{ order_info.order.order_no }}</strong>
                                                    </td>
                                                    <td>{{ order_info.order.customer_name|default:"未填写" }}</td>
                                                    <td>
                                                        <span title="{{ order_info.order.product_name }}">
                                                            {{ order_info.order.product_name|default:"未填写"|truncatechars:30 }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <div>
                                                            <span class="label label-{% if order_info.order.status == 1 %}warning{% elif order_info.order.status == 2 %}info{% elif order_info.order.status == 3 %}success{% else %}danger{% endif %}">
                                                                {{ order_info.order.get_status_display }}
                                                            </span>
                                                        </div>
                                                        {% if order_info.current_step %}
                                                        <div style="margin-top: 5px;">
                                                            <small class="text-muted">
                                                                <i class="fa fa-arrow-right"></i> 
                                                                {{ order_info.current_step }}
                                                                {% if order_info.current_step_status == '进行中' %}
                                                                    <span class="label label-primary label-xs">进行中</span>
                                                                {% elif order_info.current_step_status == '待开始' %}
                                                                    <span class="label label-default label-xs">待开始</span>
                                                                {% elif order_info.current_step_status == '已完成' %}
                                                                    <span class="label label-success label-xs">已完成</span>
                                                                {% elif order_info.current_step_status == '异常' %}
                                                                    <span class="label label-danger label-xs">异常</span>
                                                                {% else %}
                                                                    <span class="label label-warning label-xs">{{ order_info.current_step_status }}</span>
                                                                {% endif %}
                                                            </small>
                                                        </div>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if order_info.total_steps > 0 %}
                                                        <div class="progress progress-sm" style="margin-bottom: 5px;">
                                                            <div class="progress-bar" role="progressbar" style="width: {{ order_info.progress_percentage }}%;">
                                                                <span class="sr-only">{{ order_info.progress_percentage }}% 完成</span>
                                                            </div>
                                                        </div>
                                                        <small class="text-muted">
                                                            {{ order_info.completed_steps }}/{{ order_info.total_steps }} 步骤
                                                            ({{ order_info.progress_percentage }}%)
                                                        </small>
                                                        {% else %}
                                                        <small class="text-muted">无进度步骤</small>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if order_info.order.order_date %}
                                                            {{ order_info.order.order_date|date:"m-d H:i" }}
                                                        {% else %}
                                                            <span class="text-muted">未设置</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if order_info.order.delivery_date %}
                                                            {{ order_info.order.delivery_date|date:"m-d H:i" }}
                                                            {% now "Y-m-d" as today %}
                                                            {% if order_info.order.delivery_date|date:"Y-m-d" <= today and order_info.order.status != 3 %}
                                                                <span class="label label-danger label-xs">逾期</span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="text-muted">未设置</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="btn-group">
                                                            <a href="{% url 'print_order_detail' order_info.order.id %}" class="btn btn-xs btn-primary">查看</a>
                                                            {% if order_info.order.status == 2 and order_info.total_steps > 0 %}
                                                            <a href="{% url 'order_progress' order_info.order.id %}" class="btn btn-xs btn-info">进度</a>
                                                            {% endif %}
                                                            {% if order_info.order.status == 1 %}
                                                            <a href="{% url 'edit_print_order' order_info.order.id %}" class="btn btn-xs btn-warning">编辑</a>
                                                            {% endif %}
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="text-center" style="padding: 50px;">
                                        <i class="fa fa-inbox fa-3x text-muted"></i>
                                        <h4 class="text-muted">暂无{{ current_filter_name }}</h4>
                                        {% if status_filter == 'all' %}
                                        <p class="text-muted">
                                            <a href="{% url 'create_print_order' %}" class="btn btn-primary">
                                                <i class="fa fa-plus"></i> 创建第一个订单
                                            </a>
                                        </p>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.stat-card {
    padding: 20px;
    border-radius: 5px;
    color: white;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
}

.stat-icon {
    font-size: 48px;
    margin-right: 20px;
}

.stat-content h3 {
    margin: 0;
    font-size: 36px;
    font-weight: bold;
}

.stat-content p {
    margin: 0;
    font-size: 16px;
}

.panel-actions {
    float: right;
}

.panel-heading h3, .panel-heading h4 {
    margin: 0;
    display: inline-block;
}

.active-process {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 15px;
    background-color: #f9f9f9;
}

.active-process h5 {
    margin-top: 0;
    color: #337ab7;
}

.active-process p {
    margin: 5px 0;
}

.active-process .progress {
    margin: 10px 0;
}

.progress-sm {
    height: 10px;
}

.progress-xs {
    height: 3px;
}

.label-xs {
    font-size: 9px;
    padding: 1px 3px;
}

/* 加深待处理和处理中订单卡片的背景颜色 */
.bg-warning {
    background-color: #e67e22 !important; /* 更深的橙色 - 待处理订单 */
}

.bg-info {
    background-color: #2980b9 !important; /* 更深的蓝色 - 处理中订单 */
}

.bg-primary {
    background-color: #3c8dbc !important;
}

.bg-success {
    background-color: #00a65a !important; /* 保持原有绿色 - 已完成订单 */
}

.bg-danger {
    background-color: #dd4b39 !important; /* 保持原有红色 */
}
</style>
{% endblock %} 