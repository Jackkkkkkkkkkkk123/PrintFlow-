<!-- å®Œæˆæ­¥éª¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="completeStepModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">å®Œæˆæ­¥éª¤</h4>
            </div>
            <div class="modal-body">
                <form id="completeStepForm">
                    <div class="form-group">
                        <label for="complete-note">å®Œæˆå¤‡æ³¨ï¼š</label>
                        <textarea class="form-control" id="complete-note" rows="3" placeholder="è¯·è¾“å…¥å®Œæˆå¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" id="confirmComplete">ç¡®è®¤å®Œæˆ</button>
            </div>
        </div>
    </div>
</div>

<!-- è·³è¿‡æ­¥éª¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="skipStepModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">è·³è¿‡æ­¥éª¤</h4>
            </div>
            <div class="modal-body">
                <form id="skipStepForm">
                    <div class="form-group">
                        <label for="skip-reason">è·³è¿‡åŸå› ï¼š</label>
                        <textarea class="form-control" id="skip-reason" rows="3" placeholder="è¯·è¯´æ˜è·³è¿‡è¯¥æ­¥éª¤çš„åŸå› " required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-warning" id="confirmSkip">ç¡®è®¤è·³è¿‡</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    let currentStepId = null;

    // CSRF token å¤„ç†
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    $.ajaxSetup({
        headers: { "X-CSRFToken": csrftoken }
    });

    // å¼€å§‹æ­¥éª¤
    $('.start-step').on('click', function() {
        const stepId = $(this).data('step-id');
        const $button = $(this);
        
        $button.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> å¼€å§‹ä¸­...');
        
        $.ajax({
            url: `/progress/start/${stepId}/`,
            type: 'POST',
            success: function(response) {
                if (response.status) {
                    // æˆåŠŸå¼€å§‹æ­¥éª¤
                    updateStepToInProgress(stepId, response);
                    alert(response.message || 'æ­¥éª¤å¼€å§‹æˆåŠŸ');
                    location.reload(); // åˆ·æ–°é¡µé¢æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                } else if (response.need_confirmation) {
                    // éœ€è¦ç¡®è®¤ - ä¸Šä¸ªæ­¥éª¤æœ‰å¤‡æ³¨
                    $button.prop('disabled', false).html('<i class="fa fa-play"></i> å¼€å§‹');
                    showPreviousStepNoteConfirmation(stepId, response.previous_step_name, response.previous_step_note);
                } else {
                    // å…¶ä»–é”™è¯¯
                    alert('æ“ä½œå¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'));
                    $button.prop('disabled', false).html('<i class="fa fa-play"></i> å¼€å§‹');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAXé”™è¯¯:', {xhr, status, error});
                let errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.responseText) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage = response.message || errorMessage;
                    } catch (e) {
                        errorMessage = xhr.responseText;
                    }
                }
                
                alert('æ“ä½œå¤±è´¥: ' + errorMessage);
                $button.prop('disabled', false).html('<i class="fa fa-play"></i> å¼€å§‹');
            }
        });
    });

    // å®Œæˆæ­¥éª¤ - æ˜¾ç¤ºæ¨¡æ€æ¡†
    $(document).on('click', '.complete-step', function() {
        currentStepId = $(this).data('step-id');
        $('#completeStepModal').modal('show');
    });

    // ç¡®è®¤å®Œæˆæ­¥éª¤
    $('#confirmComplete').on('click', function() {
        const note = $('#complete-note').val();
        
        $.ajax({
            url: `/progress/complete/${currentStepId}/`,
            type: 'POST',
            data: JSON.stringify({note: note}),
            contentType: 'application/json',
            success: function(response) {
                if (response.status) {
                    $('#completeStepModal').modal('hide');
                    
                    // æ›´æ–°é¡µé¢æ˜¾ç¤º
                    const $row = $(`#step-${currentStepId}`);
                    $row.find('.step-status').removeClass('label-info').addClass('label-success').text('å·²å®Œæˆ');
                    $row.find('.step-confirm-user').text(response.confirm_user || '-');
                    $row.find('.step-end-time').text(response.end_time || '-');
                    if (note) {
                        $row.find('.step-note').text(note);
                    }
                    $row.find('.step-actions').html('<span class="text-success"><i class="fa fa-check-circle"></i> å·²å®Œæˆ</span>');
                    
                    if (response.all_completed) {
                        alert((response.message || 'æ­¥éª¤å®ŒæˆæˆåŠŸ') + '\n\nğŸ‰ æ­å–œï¼æ‰€æœ‰æ­¥éª¤å·²å®Œæˆï¼');
                    } else {
                        alert(response.message || 'æ­¥éª¤å®ŒæˆæˆåŠŸ');
                    }
                    location.reload(); // åˆ·æ–°é¡µé¢æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'));
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAXé”™è¯¯:', {xhr, status, error});
                let errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.responseText) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage = response.message || errorMessage;
                    } catch (e) {
                        errorMessage = xhr.responseText;
                    }
                }
                
                alert('æ“ä½œå¤±è´¥: ' + errorMessage);
            }
        });
    });

    // è·³è¿‡æ­¥éª¤ - æ˜¾ç¤ºæ¨¡æ€æ¡†
    $(document).on('click', '.skip-step', function() {
        currentStepId = $(this).data('step-id');
        $('#skipStepModal').modal('show');
    });

    // ç¡®è®¤è·³è¿‡æ­¥éª¤
    $('#confirmSkip').on('click', function() {
        const reason = $('#skip-reason').val();
        
        if (!reason.trim()) {
            alert('è¯·å¡«å†™è·³è¿‡åŸå› ');
            return;
        }
        
        $.ajax({
            url: `/progress/skip/${currentStepId}/`,
            type: 'POST',
            data: JSON.stringify({reason: reason}),
            contentType: 'application/json',
            success: function(response) {
                if (response.status) {
                    $('#skipStepModal').modal('hide');
                    
                    // æ›´æ–°é¡µé¢æ˜¾ç¤º
                    const $row = $(`#step-${currentStepId}`);
                    $row.find('.step-status').removeClass('label-info').addClass('label-warning').text('å·²è·³è¿‡');
                    $row.find('.step-confirm-user').text(response.confirm_user || '-');
                    $row.find('.step-end-time').text(response.end_time || '-');
                    $row.find('.step-note').text('è·³è¿‡åŸå› : ' + reason);
                    $row.find('.step-actions').html('<span class="text-warning"><i class="fa fa-exclamation-circle"></i> å·²è·³è¿‡</span>');
                    
                    alert(response.message || 'æ­¥éª¤è·³è¿‡æˆåŠŸ');
                    location.reload(); // åˆ·æ–°é¡µé¢æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'));
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAXé”™è¯¯:', {xhr, status, error});
                let errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.responseText) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage = response.message || errorMessage;
                    } catch (e) {
                        errorMessage = xhr.responseText;
                    }
                }
                
                alert('æ“ä½œå¤±è´¥: ' + errorMessage);
            }
        });
    });

    // æ¨¡æ€æ¡†å…³é—­æ—¶æ¸…ç©ºå†…å®¹
    $('#completeStepModal').on('hidden.bs.modal', function() {
        $('#complete-note').val('');
    });

    $('#skipStepModal').on('hidden.bs.modal', function() {
        $('#skip-reason').val('');
    });

    // æ›´æ–°æ­¥éª¤ä¸ºè¿›è¡Œä¸­çŠ¶æ€
    function updateStepToInProgress(stepId, response) {
        const $row = $(`#step-${stepId}`);
        $row.find('.step-status').removeClass('label-default').addClass('label-info').text('è¿›è¡Œä¸­');
        $row.find('.step-operator').text(response.operator || '-');
        $row.find('.step-start-time').text(response.start_time || '-');
        $row.find('.step-actions').html(`
            <button class="btn btn-sm btn-success complete-step" data-step-id="${stepId}">
                <i class="fa fa-check"></i> å®Œæˆ
            </button>
            <button class="btn btn-sm btn-warning skip-step" data-step-id="${stepId}">
                <i class="fa fa-skip-forward"></i> è·³è¿‡
            </button>
        `);
    }

    // æ˜¾ç¤ºä¸Šä¸ªæ­¥éª¤å¤‡æ³¨ç¡®è®¤å¯¹è¯æ¡†
    function showPreviousStepNoteConfirmation(stepId, previousStepName, previousStepNote) {
        // åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†HTML
        const modalHtml = `
            <div class="modal fade" id="previousStepNoteModal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                            <h4 class="modal-title">
                                <i class="fa fa-exclamation-triangle text-warning"></i> ä¸Šä¸ªæ­¥éª¤ç•™ä¸‹å¤‡æ³¨
                            </h4>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <h5><strong>æ­¥éª¤ï¼š${previousStepName}</strong></h5>
                                <p><strong>å¤‡æ³¨å†…å®¹ï¼š</strong></p>
                                <div class="well" style="margin-top: 10px;">
                                    ${previousStepNote}
                                </div>
                            </div>
                            <p>è¯·ä»”ç»†æŸ¥çœ‹ä¸Šä¸ªæ­¥éª¤çš„å¤‡æ³¨ä¿¡æ¯ï¼Œç¡®è®¤æ— è¯¯åå†å¼€å§‹ä¸‹ä¸ªæ­¥éª¤ã€‚</p>
                            <div class="text-center">
                                <p class="text-muted">
                                    <span id="countdown-display">5</span> ç§’åå¯ä»¥ç¡®è®¤å¼€å§‹
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">å–æ¶ˆ</button>
                            <button type="button" class="btn btn-primary" id="confirmStartButton" disabled>
                                <span id="countdown-text">è¯·ç­‰å¾… <span id="countdown-seconds">5</span> ç§’</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†å¹¶æ·»åŠ æ–°çš„
        $('#previousStepNoteModal').remove();
        $('body').append(modalHtml);
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        $('#previousStepNoteModal').modal('show');
        
        // å¼€å§‹å€’è®¡æ—¶
        let countdown = 5;
        const countdownInterval = setInterval(function() {
            countdown--;
            $('#countdown-display').text(countdown);
            $('#countdown-seconds').text(countdown);
            
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                // å¯ç”¨ç¡®è®¤æŒ‰é’®
                $('#confirmStartButton')
                    .prop('disabled', false)
                    .html('<i class="fa fa-play"></i> ç¡®è®¤å¼€å§‹æ­¥éª¤');
            }
        }, 1000);
        
        // ç¡®è®¤å¼€å§‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('#confirmStartButton').off('click').on('click', function() {
            if (!$(this).prop('disabled')) {
                $('#previousStepNoteModal').modal('hide');
                confirmStartStep(stepId);
            }
        });
        
        // æ¨¡æ€æ¡†å…³é—­æ—¶æ¸…ç†å€’è®¡æ—¶
        $('#previousStepNoteModal').on('hidden.bs.modal', function() {
            clearInterval(countdownInterval);
            $(this).remove();
        });
    }

    // ç¡®è®¤å¼€å§‹æ­¥éª¤ï¼ˆå½“ç”¨æˆ·å·²æŸ¥çœ‹å¤‡æ³¨åï¼‰
    function confirmStartStep(stepId) {
        const $button = $(`.start-step[data-step-id="${stepId}"]`);
        $button.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> å¼€å§‹ä¸­...');
        
        $.ajax({
            url: `/progress/confirm-start/${stepId}/`,
            type: 'POST',
            success: function(response) {
                if (response.status) {
                    updateStepToInProgress(stepId, response);
                    alert(response.message || 'æ­¥éª¤å¼€å§‹æˆåŠŸ');
                    location.reload(); // åˆ·æ–°é¡µé¢æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'));
                    $button.prop('disabled', false).html('<i class="fa fa-play"></i> å¼€å§‹');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAXé”™è¯¯:', {xhr, status, error});
                let errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
                
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.responseText) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage = response.message || errorMessage;
                    } catch (e) {
                        errorMessage = xhr.responseText;
                    }
                }
                
                alert('æ“ä½œå¤±è´¥: ' + errorMessage);
                $button.prop('disabled', false).html('<i class="fa fa-play"></i> å¼€å§‹');
            }
        });
    }
});
</script>