{% extends 'mobile/base.html' %}
{% load static %}

{% block title %}ä»ªè¡¨æ¿ - åé¾™å°åŠ¡ç®¡ç†ç³»ç»Ÿ{% endblock %}
{% block header_title %}ä»ªè¡¨æ¿{% endblock %}

{% block content %}
<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ total_orders }}</div>
        <div class="stat-label">æ€»è®¢å•</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ pending_orders }}</div>
        <div class="stat-label">å¾…å¤„ç†</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ processing_orders }}</div>
        <div class="stat-label">å¤„ç†ä¸­</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ completed_orders }}</div>
        <div class="stat-label">å·²å®Œæˆ</div>
    </div>
</div>

<!-- ä»Šæ—¥æ¦‚å†µ -->
<div class="card">
    <div class="card-title">ğŸ“Š ä»Šæ—¥æ¦‚å†µ</div>
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div style="font-size: 20px; font-weight: bold; color: #28a745;">{{ today_completed }}</div>
            <div style="font-size: 12px; color: #666;">ä»Šæ—¥å®Œæˆæ­¥éª¤</div>
        </div>
        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div style="font-size: 20px; font-weight: bold; color: #dc3545;">{{ urgent_orders|length }}</div>
            <div style="font-size: 12px; color: #666;">ç´§æ€¥è®¢å•</div>
        </div>
    </div>
</div>

<!-- å½“å‰è¿›è¡Œä¸­çš„æ­¥éª¤ -->
<div class="card">
    <div class="card-title">ğŸ”„ è¿›è¡Œä¸­çš„æ­¥éª¤</div>
    {% if current_steps %}
        {% for step in current_steps %}
        <div class="list-item">
            <div class="list-item-header">
                <div class="list-item-title">{{ step.order.product_name|default:"æœªå‘½åäº§å“" }} - {{ step.step_name }}</div>
                <span class="status-badge status-processing">è¿›è¡Œä¸­</span>
            </div>
            <div style="font-size: 12px; color: #666;">
                è®¢å•å·ï¼š{{ step.order.order_no }} | æ“ä½œå‘˜ï¼š{{ step.operator.username|default:"æœªåˆ†é…" }}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 20px; color: #666;">
            æš‚æ— è¿›è¡Œä¸­çš„æ­¥éª¤
        </div>
    {% endif %}
</div>

<!-- å¾…å¼€å§‹çš„æ­¥éª¤ -->
<div class="card">
    <div class="card-title">â³ å¾…å¼€å§‹çš„æ­¥éª¤</div>
    {% if next_steps %}
        {% for step in next_steps|slice:":5" %}
        <div class="list-item">
            <div class="list-item-header">
                <div class="list-item-title">{{ step.order.product_name|default:"æœªå‘½åäº§å“" }} - {{ step.step_name }}</div>
                <span class="status-badge status-pending">å¾…å¼€å§‹</span>
            </div>
            <div style="font-size: 12px; color: #666;">
                è®¢å•å·ï¼š{{ step.order.order_no }}
            </div>
        </div>
        {% endfor %}
        {% if next_steps|length > 5 %}
        <div style="text-align: center; margin-top: 10px;">
            <a href="{% url 'mobile_orders' %}" class="btn btn-outline">æŸ¥çœ‹å…¨éƒ¨ {{ next_steps|length }} ä¸ªå¾…å¤„ç†æ­¥éª¤</a>
        </div>
        {% endif %}
    {% else %}
        <div style="text-align: center; padding: 20px; color: #666;">
            æš‚æ— å¾…å¼€å§‹çš„æ­¥éª¤
        </div>
    {% endif %}
</div>

<!-- ç´§æ€¥è®¢å• -->
{% if urgent_orders %}
<div class="card">
    <div class="card-title">ğŸš¨ ç´§æ€¥è®¢å•</div>
    {% for order in urgent_orders %}
    <div class="list-item" style="border-left: 3px solid #dc3545;">
        <div class="list-item-header">
            <div class="list-item-title">{{ order.product_name|default:"æœªå‘½åäº§å“" }}</div>
            <span class="status-badge status-{% if order.status == 1 %}pending{% elif order.status == 2 %}processing{% endif %}">
                {% if order.status == 1 %}å¾…å¤„ç†{% elif order.status == 2 %}å¤„ç†ä¸­{% endif %}
            </span>
        </div>
        <div style="font-size: 12px; color: #dc3545;">
            è®¢å•å·ï¼š{{ order.order_no }} | äº¤æœŸï¼š{{ order.delivery_date|date:"Y-m-d" }}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
    <a href="{% url 'mobile_orders' %}" class="btn btn-primary">ğŸ“‹ æŸ¥çœ‹è®¢å•</a>
    <a href="{% url 'mobile_ai_assistant' %}" class="btn btn-outline">ğŸ¤– AIåŠ©æ‰‹</a>
</div>

<div style="text-align: center; margin-top: 15px;">
    <button class="btn btn-outline" onclick="refreshDashboard()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
// åˆ·æ–°ä»ªè¡¨æ¿
function refreshDashboard() {
    showNotification('æ­£åœ¨åˆ·æ–°ä»ªè¡¨æ¿æ•°æ®...', 'info');
    setTimeout(() => {
        location.reload();
    }, 500);
}

// åˆå§‹åŒ–é¡µé¢
document.addEventListener('DOMContentLoaded', function() {
    console.log('ä»ªè¡¨æ¿é¡µé¢åŠ è½½å®Œæˆ');
    
    // åˆå§‹åŒ–WebSocketè¿æ¥æ¥å®æ—¶æ›´æ–°æ•°æ®
    initWebSocketConnection();
});

// åˆå§‹åŒ–WebSocketè¿æ¥
function initWebSocketConnection() {
    if (typeof WebSocket !== 'undefined') {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/notifications/`;
        
        const socket = new WebSocket(wsUrl);
        
        socket.onopen = function(event) {
            console.log('ğŸ“Š ä»ªè¡¨æ¿WebSocketè¿æ¥æˆåŠŸ');
            showNotification('å®æ—¶æ›´æ–°å·²è¿æ¥', 'success');
        };
        
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('ğŸ“Š æ”¶åˆ°WebSocketæ¶ˆæ¯:', data);
            
            // ä»ªè¡¨æ¿å¯¹æ‰€æœ‰ç±»å‹çš„æ›´æ–°éƒ½æ„Ÿå…´è¶£
            if (data.type === 'progress_notification' || data.type === 'dashboard_update') {
                showNotification('æ•°æ®å·²æ›´æ–°', 'info');
                // å»¶è¿Ÿåˆ·æ–°ï¼Œè®©ç”¨æˆ·çœ‹åˆ°é€šçŸ¥
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        };
        
        socket.onclose = function(event) {
            console.log('ğŸ“Š WebSocketè¿æ¥å…³é—­');
            showNotification('å®æ—¶æ›´æ–°å·²æ–­å¼€', 'error');
        };
        
        socket.onerror = function(error) {
            console.error('ğŸ“Š WebSocketé”™è¯¯:', error);
        };
    }
}
</script>
{% endblock %} 