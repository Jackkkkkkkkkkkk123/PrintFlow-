{% extends 'mobile/base.html' %}
{% load static %}

{% block title %}AIåŠ©æ‰‹ - åé¾™å°åŠ¡ç®¡ç†ç³»ç»Ÿ{% endblock %}
{% block header_title %}AIåŠ©æ‰‹{% endblock %}

{% block content %}
<!-- AIåŠ©æ‰‹ä»‹ç» -->
<div class="card">
    <div class="card-title">ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹</div>
    <div style="color: #666; margin-bottom: 15px;">
        æ‚¨çš„æ™ºèƒ½å°åˆ·ç®¡ç†åŠ©æ‰‹ï¼Œå¸®æ‚¨åˆ†æè®¢å•æ•°æ®ï¼Œç”Ÿæˆæ—¥æŠ¥ï¼Œå‘ç°å¼‚å¸¸æƒ…å†µã€‚ç°åœ¨æ”¯æŒè‡ªç„¶è¯­è¨€å¯¹è¯ï¼
    </div>
    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-size: 12px; color: #666;">
        <div style="margin-bottom: 8px;">ğŸ’¬ æ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢è®¢å•ä¿¡æ¯</div>
        <div style="margin-bottom: 8px;">ğŸ“Š è‡ªåŠ¨åˆ†æè®¢å•æ•°æ®</div>
        <div style="margin-bottom: 8px;">ğŸ“ ç”Ÿæˆæ¯æ—¥å·¥ä½œæŠ¥å‘Š</div>
        <div style="margin-bottom: 8px;">âš ï¸ è¯†åˆ«å¼‚å¸¸è®¢å•å’Œå»¶æœŸé£é™©</div>
        <div>â° æ¯å¤©ä¸‹åˆ5:30è‡ªåŠ¨å‘é€æ—¥æŠ¥</div>
    </div>
</div>

<!-- æ™ºèƒ½å¯¹è¯åŒºåŸŸ -->
<div class="card">
    <div class="card-title">ğŸ’¬ æ™ºèƒ½å¯¹è¯</div>
    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 12px; color: #666;">
        <strong>ğŸ’¡ è¯•è¯•é—®æˆ‘ï¼š</strong><br>
        â€¢ "ä»Šå¤©æœ‰å¤šå°‘ä¸ªæ–°è®¢å•ï¼Ÿ"<br>
        â€¢ "æŸ¥è¯¢è®¢å•å·ABC123çš„è¯¦æƒ…"<br>
        â€¢ "æœ‰å“ªäº›ç´§æ€¥äº¤æœŸçš„è®¢å•ï¼Ÿ"<br>
        â€¢ "æ˜¾ç¤ºå¤„ç†ä¸­çš„è®¢å•"
    </div>
    
    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
    <div id="chat-messages" style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; height: 300px; overflow-y: auto; padding: 15px; margin-bottom: 15px;">
        <div class="ai-message">
            <div style="display: flex; align-items: flex-start; margin-bottom: 15px;">
                <div style="background: #667eea; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 14px;">ğŸ¤–</div>
                <div style="background: #f1f3f4; padding: 10px; border-radius: 10px; max-width: 80%; word-wrap: break-word;">
                    æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨æŸ¥è¯¢è®¢å•ä¿¡æ¯ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ
                </div>
            </div>
        </div>
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div style="display: flex; gap: 10px;">
        <input type="text" id="chat-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" onkeypress="handleChatKeyPress(event)">
        <button id="send-btn" onclick="sendChatMessage()" style="background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; cursor: pointer;">å‘é€</button>
    </div>
    
    <!-- å¿«æ·é—®é¢˜æŒ‰é’® -->
    <div style="margin-top: 15px;">
        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">ğŸ”¥ å¿«æ·é—®é¢˜ï¼š</div>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button class="quick-question-btn" onclick="askQuickQuestion('ä»Šå¤©æœ‰å¤šå°‘ä¸ªæ–°è®¢å•ï¼Ÿ')">ä»Šæ—¥è®¢å•</button>
            <button class="quick-question-btn" onclick="askQuickQuestion('æ˜¾ç¤ºæ‰€æœ‰å¤„ç†ä¸­çš„è®¢å•')">å¤„ç†ä¸­è®¢å•</button>
            <button class="quick-question-btn" onclick="askQuickQuestion('æœ‰å“ªäº›ç´§æ€¥äº¤æœŸçš„è®¢å•ï¼Ÿ')">ç´§æ€¥è®¢å•</button>
            <button class="quick-question-btn" onclick="askQuickQuestion('è®¢å•ç»Ÿè®¡ä¿¡æ¯')">ç»Ÿè®¡ä¿¡æ¯</button>
        </div>
        
        <!-- ğŸš€ å¿«é€Ÿæµ‹è¯•æŒ‰é’®ï¼ˆæ–°å¢ï¼‰ -->
        <div style="margin-top: 10px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">âš¡ è¶…å¿«æŸ¥è¯¢ï¼ˆ0.1ç§’å“åº”ï¼‰ï¼š</div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                <button class="quick-test-btn" onclick="quickTest('stats')">ğŸ“Š ç»Ÿè®¡</button>
                <button class="quick-test-btn" onclick="quickTest('today')">ğŸ“… ä»Šå¤©</button>
                <button class="quick-test-btn" onclick="quickTest('urgent')">ğŸš¨ ç´§æ€¥</button>
                <button class="quick-test-btn" onclick="quickTest('processing')">âš¡ å¤„ç†ä¸­</button>
            </div>
        </div>
        
        <!-- æµå¼å“åº”æ¼”ç¤º -->
        <div style="margin-top: 10px;">
            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">ğŸŒŠ æµå¼å“åº”æ¼”ç¤ºï¼š</div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                <button class="stream-demo-btn" onclick="askQuickQuestion('è¯¦ç»†åˆ†æä»Šå¤©çš„è®¢å•æƒ…å†µï¼ŒåŒ…æ‹¬çŠ¶æ€åˆ†å¸ƒå’Œç´§æ€¥ç¨‹åº¦')">è¯¦ç»†åˆ†æ</button>
                <button class="stream-demo-btn" onclick="askQuickQuestion('å¸®æˆ‘ç”Ÿæˆä¸€ä»½ä»Šæ—¥è®¢å•å¤„ç†æŠ¥å‘Š')">ç”ŸæˆæŠ¥å‘Š</button>
            </div>
        </div>
    </div>
</div>

<!-- å¿«é€Ÿæ“ä½œ -->
<div class="card">
    <div class="card-title">âš¡ å¿«é€Ÿæ“ä½œ</div>
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
        <button class="btn btn-primary" onclick="generateDailyReport()">
            ğŸ“Š<br>ç”Ÿæˆæ—¥æŠ¥
        </button>
        <button class="btn btn-outline" onclick="analyzeAnomalies()">
            ğŸ”<br>å¼‚å¸¸åˆ†æ
        </button>
        <button class="btn btn-outline" onclick="checkDeadlines()">
            â°<br>äº¤æœŸæ£€æŸ¥
        </button>
        <button class="btn btn-outline" onclick="clearChatHistory()">
            ğŸ§¹<br>æ¸…é™¤å¯¹è¯
        </button>
        <!-- <button class="btn btn-outline" onclick="clearAIMemory()">
            ğŸ§¹<br>æ¸…é™¤AIè®°å¿†
        </button> -->
    </div>
</div>

<!-- è°ƒè¯•æŒ‰é’® -->
<div class="card" style="background: #f8f9fa; border: 1px dashed #ccc;">
    <div class="card-title">ğŸ”§ è°ƒè¯•ä¿¡æ¯</div>
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
        <button class="btn" style="background: #17a2b8; color: white;" onclick="testAIAPI()">
            ğŸ§ª æµ‹è¯•AI API
        </button>
        <button class="btn" style="background: #28a745; color: white;" onclick="testConversationAPI()">
            ğŸ—£ï¸ æµ‹è¯•å¯¹è¯API
        </button>
        <button class="btn" style="background: #ffc107; color: black;" onclick="testStreamingAPI()">
            ğŸŒŠ æµ‹è¯•æµå¼API
        </button>
        <button class="btn" style="background: #6f42c1; color: white;" onclick="clearDebugInfo()">
            ğŸ§¹ æ¸…é™¤è°ƒè¯•
        </button>
        <div id="debug-info" style="grid-column: 1 / -1; font-size: 11px; background: #fff; padding: 10px; border-radius: 5px; color: #666; max-height: 300px; overflow-y: auto; font-family: monospace;"></div>
    </div>
    
    <!-- å®æ—¶è¿æ¥çŠ¶æ€ -->
    <div style="margin-top: 15px; padding: 10px; background: #fff; border-radius: 5px; border: 1px solid #ddd;">
        <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">ğŸ”— è¿æ¥çŠ¶æ€</div>
        <div id="connection-status" style="font-size: 11px; color: #666;">
            <div>SSEè¿æ¥: <span id="sse-status">æœªè¿æ¥</span></div>
            <div>æœ€åäº‹ä»¶: <span id="last-event">æ— </span></div>
            <div>æ¥æ”¶äº‹ä»¶æ•°: <span id="event-count">0</span></div>
            <div>å½“å‰çŠ¶æ€: <span id="current-status">ç©ºé—²</span></div>
        </div>
    </div>
</div>

<!-- ä»Šæ—¥æ‘˜è¦ -->
<div class="card">
    <div class="card-title">ğŸ“… ä»Šæ—¥æ‘˜è¦</div>
    <div id="today-summary" style="color: #666; text-align: center; padding: 20px;">
        ç‚¹å‡»"ç”Ÿæˆæ—¥æŠ¥"è·å–ä»Šæ—¥æ•°æ®æ‘˜è¦...
    </div>
</div>

<!-- å¼‚å¸¸è­¦å‘Š -->
<div class="card" id="alerts-card" style="display: none;">
    <div class="card-title">ğŸš¨ å¼‚å¸¸è­¦å‘Š</div>
    <div id="alerts-content"></div>
</div>

<!-- åˆ†æç»“æœ -->
<div class="card" id="analysis-card" style="display: none;">
    <div class="card-title">ğŸ“Š åˆ†æç»“æœ</div>
    <div id="analysis-content"></div>
</div>

<!-- å†å²æŠ¥å‘Š -->
<div class="card" id="reports-card" style="display: none;">
    <div class="card-title">ğŸ“‹ å†å²æŠ¥å‘Š</div>
    <div id="reports-content">
        <div style="text-align: center; color: #666; padding: 20px;">
            æš‚æ— å†å²æŠ¥å‘Šæ•°æ®
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* å¿«æ·é—®é¢˜æŒ‰é’®æ ·å¼ */
.quick-question-btn {
    background: #e3f2fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.quick-question-btn:hover {
    background: #bbdefb;
    transform: translateY(-1px);
}

/* èŠå¤©æ¶ˆæ¯æ ·å¼ */
.user-message {
    display: flex;
    align-items: flex-start;
    margin-bottom: 15px;
    flex-direction: row-reverse;
}

.user-message .message-bubble {
    background: #667eea;
    color: white;
    padding: 10px;
    border-radius: 10px;
    max-width: 80%;
    word-wrap: break-word;
    margin-left: 10px;
}

.ai-message {
    display: flex;
    align-items: flex-start;
    margin-bottom: 15px;
}

.ai-message .message-bubble {
    background: #f1f3f4;
    color: #333;
    padding: 10px;
    border-radius: 10px;
    max-width: 80%;
    word-wrap: break-word;
    margin-left: 10px;
}

.message-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
}

.user-avatar {
    background: #667eea;
    color: white;
}

.ai-avatar {
    background: #667eea;
    color: white;
}

/* åŠ è½½åŠ¨ç”» */
.typing-indicator {
    display: flex;
    align-items: center;
    padding: 10px;
    background: #f1f3f4;
    border-radius: 10px;
    margin-left: 40px;
    max-width: 80px;
}

.typing-indicator span {
    height: 6px;
    width: 6px;
    float: left;
    margin: 0 1px;
    background-color: #9E9EA1;
    display: block;
    border-radius: 50%;
    opacity: 0.4;
    animation: 1s blink infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: .2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: .4s;
}

@keyframes blink {
    50% {
        opacity: 1;
    }
}

/* å¿«é€Ÿæµ‹è¯•æŒ‰é’®æ ·å¼ */
.quick-test-btn {
    background: #e8f5e8;
    color: #2e7d32;
    border: 1px solid #a5d6a7;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: bold;
}

.quick-test-btn:hover {
    background: #c8e6c9;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(46, 125, 50, 0.2);
}

/* æµå¼æ¼”ç¤ºæŒ‰é’®æ ·å¼ */
.stream-demo-btn {
    background: #fff3e0;
    color: #f57c00;
    border: 1px solid #ffcc02;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s;
}

.stream-demo-btn:hover {
    background: #ffe0b2;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(245, 124, 0, 0.2);
}

/* æ‰“å­—å…‰æ ‡æ ·å¼ */
.typing-cursor {
    color: #667eea;
    font-weight: bold;
    animation: blink-cursor 1s infinite;
}

@keyframes blink-cursor {
    0%, 50% {
        opacity: 1;
    }
    51%, 100% {
        opacity: 0;
    }
}

/* æµå¼å†…å®¹å®¹å™¨ä¼˜åŒ– */
#streaming-content {
    word-wrap: break-word;
    white-space: pre-wrap;
    line-height: 1.4;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆå·²ç¦ç”¨ï¼‰
function showLoading() {
    // document.getElementById('loading-overlay').style.display = 'flex';
    console.log('å¼€å§‹å¤„ç†è¯·æ±‚...');
}

// éšè—åŠ è½½çŠ¶æ€ï¼ˆå·²ç¦ç”¨ï¼‰
function hideLoading() {
    // document.getElementById('loading-overlay').style.display = 'none';
    console.log('è¯·æ±‚å¤„ç†å®Œæˆ');
}

// å¼ºåˆ¶å…³é—­åŠ è½½çŠ¶æ€ï¼ˆå·²ç¦ç”¨ï¼‰
function forceHideLoading() {
    // document.getElementById('loading-overlay').style.display = 'none';
    console.log('å¼ºåˆ¶å…³é—­åŠ è½½æ¡†');
    showNotification('å·²å–æ¶ˆæ“ä½œ', 'info');
}



async function clearAIMemory() {
    if (!confirm('ç¡®å®šè¦æ¸…é™¤AIåŠ©æ‰‹çš„å…¨éƒ¨è®°å¿†å—ï¼Ÿ')) {
        return;
    }
    try {
        const response = await fetch('/mobile/ai-assistant/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action: 'clear_memory' })
        });
        const data = await response.json();
        if (data.status === 'success') {
            showNotification('AIè®°å¿†å·²æ¸…ç©º', 'success');
        } else {
            showNotification('æ¸…é™¤å¤±è´¥ï¼š' + (data.message || data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    } catch (error) {
        showNotification('æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
    }
}






// ç”Ÿæˆæ—¥æŠ¥
async function generateDailyReport() {
    showLoading();
    
    // 10ç§’è¶…æ—¶æœºåˆ¶
    const timeoutId = setTimeout(() => {
        // hideLoading(); // å·²ç¦ç”¨åŠ è½½æ¡†
        showNotification('è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•', 'error');
        console.error('APIè¯·æ±‚è¶…æ—¶');
    }, 10000);
    
    try {
        const csrfToken = getCsrfToken();
        console.log('CSRF Token:', csrfToken);
        console.log('å‘é€AIæ—¥æŠ¥è¯·æ±‚...');
        
        const controller = new AbortController();
        const timeoutSignal = setTimeout(() => controller.abort(), 8000);
        
        const response = await fetch('/api/ai/daily-report/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutSignal);
        console.log('å“åº”çŠ¶æ€:', response.status);
        console.log('å“åº”OK:', response.ok);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('HTTPé”™è¯¯å“åº”:', errorText);
            showNotification(`HTTPé”™è¯¯ ${response.status}: ${errorText}`, 'error');
            return;
        }
        
        const data = await response.json();
        console.log('å“åº”æ•°æ®:', data);
        
        if (data.status === 'success') {
            document.getElementById('today-summary').innerHTML = data.report;
            showNotification('æ—¥æŠ¥ç”ŸæˆæˆåŠŸ', 'success');
        } else {
            console.error('ä¸šåŠ¡é”™è¯¯:', data.message);
            showNotification('æ—¥æŠ¥ç”Ÿæˆå¤±è´¥ï¼š' + (data.message || data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            console.error('è¯·æ±‚è¢«å–æ¶ˆ');
            showNotification('è¯·æ±‚è¢«å–æ¶ˆ', 'info');
        } else {
            console.error('ç”Ÿæˆæ—¥æŠ¥é”™è¯¯:', error);
            showNotification('ç½‘ç»œé”™è¯¯ï¼š' + error.message, 'error');
        }
    } finally {
        clearTimeout(timeoutId);
        hideLoading();
    }
}

// åˆ†æå¼‚å¸¸
async function analyzeAnomalies() {
    showLoading();
    try {
        const response = await fetch('/api/ai/analyze-anomalies/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            const alertsCard = document.getElementById('alerts-card');
            const alertsContent = document.getElementById('alerts-content');
            
            alertsContent.innerHTML = data.anomalies;
            alertsCard.style.display = 'block';
            
            showNotification('å¼‚å¸¸åˆ†æå®Œæˆ', 'success');
        } else {
            showNotification('å¼‚å¸¸åˆ†æå¤±è´¥ï¼š' + data.message, 'error');
        }
    } catch (error) {
        console.error('å¼‚å¸¸åˆ†æé”™è¯¯:', error);
        showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    } finally {
        hideLoading();
    }
}

// æ£€æŸ¥äº¤æœŸ
async function checkDeadlines() {
    showLoading();
    try {
        const response = await fetch('/api/ai/check-deadlines/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            const analysisCard = document.getElementById('analysis-card');
            const analysisContent = document.getElementById('analysis-content');
            
            analysisContent.innerHTML = data.deadline_analysis;
            analysisCard.style.display = 'block';
            
            showNotification('äº¤æœŸæ£€æŸ¥å®Œæˆ', 'success');
        } else {
            showNotification('äº¤æœŸæ£€æŸ¥å¤±è´¥ï¼š' + data.message, 'error');
        }
    } catch (error) {
        console.error('äº¤æœŸæ£€æŸ¥é”™è¯¯:', error);
        showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
    } finally {
        hideLoading();
    }
}

// æŸ¥çœ‹å†å²æŠ¥å‘Š
function viewReports() {
    const reportsCard = document.getElementById('reports-card');
    const reportsContent = document.getElementById('reports-content');
    
    // è¿™é‡Œå¯ä»¥æ·»åŠ è·å–å†å²æŠ¥å‘Šçš„APIè°ƒç”¨
    reportsContent.innerHTML = `
        <div style="color: #666; text-align: center; padding: 20px;">
            å†å²æŠ¥å‘ŠåŠŸèƒ½å¼€å‘ä¸­...<br>
            å°†æ˜¾ç¤ºè¿‡å»30å¤©çš„AIç”ŸæˆæŠ¥å‘Š
        </div>
    `;
    
    reportsCard.style.display = 'block';
    showNotification('å†å²æŠ¥å‘ŠåŠŸèƒ½å¼€å‘ä¸­', 'info');
}

// è·å–CSRF Token
function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// æ£€æŸ¥è‡ªåŠ¨æŠ¥å‘Š
function checkAutoReport() {
    // è¿™é‡Œå¯ä»¥æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨ç”Ÿæˆçš„æŠ¥å‘Š
    const now = new Date();
    const hour = now.getHours();
    const minute = now.getMinutes();
    
    // å¦‚æœæ˜¯ä¸‹åˆ5:30å·¦å³ï¼Œæç¤ºç”¨æˆ·æŸ¥çœ‹è‡ªåŠ¨æŠ¥å‘Š
    if (hour === 17 && minute >= 30 && minute <= 35) {
        showNotification('ğŸ“Š ä»Šæ—¥è‡ªåŠ¨æŠ¥å‘Šå·²ç”Ÿæˆï¼Œç‚¹å‡»"ç”Ÿæˆæ—¥æŠ¥"æŸ¥çœ‹', 'info');
    }
}

// æµ‹è¯•AI APIåŠŸèƒ½
async function testAIAPI() {
    const debugInfo = document.getElementById('debug-info');
    
    function addDebugLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        debugInfo.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        debugInfo.scrollTop = debugInfo.scrollHeight;
    }
    
    addDebugLog('ğŸ”„ å¼€å§‹æµ‹è¯•AI API...');
    
    try {
        // 1. æ£€æŸ¥åŸºæœ¬ä¿¡æ¯
        addDebugLog(`ğŸ“± User Agent: ${navigator.userAgent.slice(0, 50)}...`);
        addDebugLog(`ğŸª Cookies: ${document.cookie ? 'å­˜åœ¨' : 'æ— '}`);
        
        // 2. æ£€æŸ¥CSRF Token
        const csrfToken = getCsrfToken();
        addDebugLog(`ğŸ” CSRF Token: ${csrfToken ? csrfToken.slice(0, 10) + '...' : 'æœªæ‰¾åˆ°'}`);
        
        // 3. æµ‹è¯•APIè¿æ¥
        addDebugLog('ğŸ“¡ å‘é€æµ‹è¯•è¯·æ±‚...');
        
        const response = await fetch('/api/ai/daily-report/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });
        
        addDebugLog(`ğŸ“Š å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
        addDebugLog(`âœ… å“åº”OK: ${response.ok}`);
        
        // 4. æ£€æŸ¥å“åº”å†…å®¹
        const responseText = await response.text();
        addDebugLog(`ğŸ“ å“åº”é•¿åº¦: ${responseText.length} å­—ç¬¦`);
        
        try {
            const data = JSON.parse(responseText);
            addDebugLog(`ğŸ¯ JSONè§£ææˆåŠŸ: ${JSON.stringify(data).slice(0, 100)}...`);
            
            if (data.status === 'success') {
                addDebugLog('âœ… APIè°ƒç”¨æˆåŠŸï¼');
                showNotification('AI APIæµ‹è¯•æˆåŠŸ', 'success');
            } else {
                addDebugLog(`âŒ ä¸šåŠ¡é”™è¯¯: ${data.message || data.error}`);
                showNotification(`APIä¸šåŠ¡é”™è¯¯: ${data.message || data.error}`, 'error');
            }
        } catch (jsonError) {
            addDebugLog(`âŒ JSONè§£æå¤±è´¥: ${jsonError.message}`);
            addDebugLog(`ğŸ“„ åŸå§‹å“åº”: ${responseText.slice(0, 200)}...`);
            showNotification('å“åº”æ ¼å¼é”™è¯¯', 'error');
        }
        
    } catch (error) {
        addDebugLog(`ğŸ’¥ è¯·æ±‚å¤±è´¥: ${error.message}`);
        addDebugLog(`ğŸ” é”™è¯¯ç±»å‹: ${error.name}`);
        showNotification(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
    }
    
    addDebugLog('ğŸ æµ‹è¯•å®Œæˆ');
}

// ======================
// å¯¹è¯åŠŸèƒ½ç›¸å…³å‡½æ•°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
// ======================

// å…¨å±€å˜é‡
let currentEventSource = null;  // å½“å‰çš„SSEè¿æ¥
let isProcessing = false;       // æ˜¯å¦æ­£åœ¨å¤„ç†è¯·æ±‚

// å‘é€èŠå¤©æ¶ˆæ¯ï¼ˆæµå¼ç‰ˆæœ¬ï¼‰
async function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message) {
        showNotification('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
        return;
    }
    
    if (isProcessing) {
        showNotification('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...', 'info');
        return;
    }
    
    // è®¾ç½®å¤„ç†çŠ¶æ€
    isProcessing = true;
    
    // ç¦ç”¨è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®
    input.disabled = true;
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = 'å–æ¶ˆ';
    sendBtn.onclick = cancelCurrentRequest;
    
    try {
        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        addChatMessage(message, 'user');
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        input.value = '';
        
        // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥çš„æŒ‡ç¤ºå™¨
        showTypingIndicator();
        
        // ğŸš€ ä½¿ç”¨æµå¼APIï¼ˆServer-Sent Eventsï¼‰
        await sendStreamingRequest(message);
        
    } catch (error) {
        hideTypingIndicator();
        console.error('å‘é€æ¶ˆæ¯é”™è¯¯:', error);
        addChatMessage('æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºç°äº†é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'ai');
        showNotification('å‘é€å¤±è´¥: ' + error.message, 'error');
    } finally {
        // é‡æ–°å¯ç”¨è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®
        resetInputState();
    }
}

// æµå¼è¯·æ±‚å¤„ç†
async function sendStreamingRequest(message) {
    return new Promise((resolve, reject) => {
        try {
            // ç¼–ç æ¶ˆæ¯ç”¨äºURLå‚æ•°
            const encodedMessage = encodeURIComponent(message);
            const sseUrl = `/api/conversation/stream/?message=${encodedMessage}`;
            
            console.log('ğŸ”— å»ºç«‹SSEè¿æ¥:', sseUrl);
            
            // åˆ›å»ºServer-Sent Eventsè¿æ¥
            const eventSource = new EventSource(sseUrl);
            currentEventSource = eventSource;
            
            let aiMessageElement = null;
            let currentContent = '';
            let hasReceivedContent = false;
            let eventCounter = 0;
            
            // è¿æ¥å»ºç«‹æˆåŠŸ
            eventSource.onopen = function(event) {
                console.log('âœ… SSEè¿æ¥å·²å»ºç«‹');
                updateConnectionStatus('å·²è¿æ¥', 'è¿æ¥æˆåŠŸ', 0);
            };
            
            // ç›‘å¬æ¶ˆæ¯äº‹ä»¶
            eventSource.onmessage = function(event) {
                try {
                    eventCounter++;
                    console.log('ğŸ“¨ æ”¶åˆ°SSEæ•°æ®:', event.data);
                    updateConnectionStatus('å·²è¿æ¥', event.data.substring(0, 50), eventCounter);
                    
                    const data = JSON.parse(event.data);
                    
                    switch (data.type) {
                        case 'start':
                            console.log('ğŸš€ å¼€å§‹å¤„ç†');
                            updateTypingIndicator(data.message);
                            break;
                            
                        case 'status':
                            console.log('ğŸ“Š çŠ¶æ€æ›´æ–°:', data.message);
                            updateTypingIndicator(data.message);
                            break;
                            
                        case 'content':
                            console.log('ğŸ“ å†…å®¹æ•°æ®:', data.content);
                            hasReceivedContent = true;
                            
                            // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨ï¼ˆå¦‚æœè¿˜åœ¨ï¼‰
                            hideTypingIndicator();
                            
                            // åˆ›å»ºæˆ–æ›´æ–°AIæ¶ˆæ¯å…ƒç´ 
                            if (!aiMessageElement) {
                                aiMessageElement = createAIMessageElement();
                            }
                            
                            // è¿½åŠ å†…å®¹
                            currentContent += data.content;
                            updateAIMessageContent(aiMessageElement, currentContent);
                            break;
                            
                        case 'complete':
                            console.log('âœ… å›å¤å®Œæˆ:', data.message);
                            hideTypingIndicator();
                            
                            // å¦‚æœæ²¡æœ‰æ”¶åˆ°ä»»ä½•å†…å®¹ï¼Œæ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
                            if (!hasReceivedContent && !aiMessageElement) {
                                addChatMessage('å›å¤å®Œæˆï¼Œä½†æ²¡æœ‰æ”¶åˆ°å†…å®¹ã€‚', 'ai');
                            } else if (aiMessageElement) {
                                // å®ŒæˆAIæ¶ˆæ¯æ˜¾ç¤ºï¼Œç§»é™¤æ‰“å­—å…‰æ ‡
                                finalizeAIMessage(aiMessageElement);
                            }
                            
                            eventSource.close();
                            currentEventSource = null;
                            updateConnectionStatus('å·²å…³é—­', 'å¯¹è¯å®Œæˆ', eventCounter);
                            resolve();
                            break;
                            
                        case 'end':
                            console.log('ğŸ æµå¼å“åº”ç»“æŸ');
                            
                            if (aiMessageElement) {
                                // å®ŒæˆAIæ¶ˆæ¯æ˜¾ç¤ºï¼Œç§»é™¤æ‰“å­—å…‰æ ‡
                                finalizeAIMessage(aiMessageElement);
                            }
                            
                            eventSource.close();
                            currentEventSource = null;
                            updateConnectionStatus('å·²å…³é—­', 'æµå¼å“åº”ç»“æŸ', eventCounter);
                            resolve();
                            break;
                            
                        case 'error':
                            console.error('âŒ AIé”™è¯¯:', data.message);
                            hideTypingIndicator();
                            
                            if (!aiMessageElement) {
                                addChatMessage(data.message, 'ai');
                            } else {
                                updateAIMessageContent(aiMessageElement, currentContent + '\n\nâŒ ' + data.message);
                            }
                            
                            eventSource.close();
                            currentEventSource = null;
                            updateConnectionStatus('é”™è¯¯', data.message, eventCounter);
                            reject(new Error(data.message));
                            break;
                            
                        default:
                            console.log('ğŸ”„ å…¶ä»–äº‹ä»¶ç±»å‹:', data.type);
                            break;
                    }
                } catch (parseError) {
                    console.error('âŒ è§£æSSEæ•°æ®å¤±è´¥:', parseError, 'Raw data:', event.data);
                    updateConnectionStatus('è§£æé”™è¯¯', parseError.message, eventCounter);
                }
            };
            
            // ç›‘å¬è¿æ¥å…³é—­äº‹ä»¶
            eventSource.addEventListener('close', function(event) {
                console.log('ğŸ”’ SSEè¿æ¥å…³é—­');
                eventSource.close();
                currentEventSource = null;
                updateConnectionStatus('å·²å…³é—­', 'è¿æ¥å·²å…³é—­', 0);
                resolve();
            });
            
            // ç›‘å¬é”™è¯¯äº‹ä»¶
            eventSource.onerror = function(event) {
                console.error('âŒ SSEè¿æ¥é”™è¯¯:', event);
                
                // æ£€æŸ¥è¿æ¥çŠ¶æ€
                if (eventSource.readyState === EventSource.CLOSED) {
                    console.log('è¿æ¥å·²å…³é—­');
                } else if (eventSource.readyState === EventSource.CONNECTING) {
                    console.log('æ­£åœ¨é‡è¿...');
                    return; // è®©æµè§ˆå™¨è‡ªåŠ¨é‡è¿
                }
                
                eventSource.close();
                currentEventSource = null;
                
                if (!hasReceivedContent && !aiMessageElement) {
                    addChatMessage('è¿æ¥ä¸­æ–­ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'ai');
                }
                
                updateConnectionStatus('é”™è¯¯', 'è¿æ¥é”™è¯¯', 0);
                reject(new Error('è¿æ¥ä¸­æ–­'));
            };
            
            // è®¾ç½®è¶…æ—¶ - å¢åŠ åˆ°60ç§’ï¼Œç»™AIæ›´å¤šæ—¶é—´
            const timeoutId = setTimeout(() => {
                if (currentEventSource) {
                    console.log('â° è¯·æ±‚è¶…æ—¶ï¼Œè‡ªåŠ¨å–æ¶ˆ');
                    cancelCurrentRequest();
                    reject(new Error('è¯·æ±‚è¶…æ—¶ï¼ˆ60ç§’ï¼‰'));
                }
            }, 60000);  // 60ç§’è¶…æ—¶
            
            // æ¸…ç†è¶…æ—¶å®šæ—¶å™¨
            const originalResolve = resolve;
            const originalReject = reject;
            
            resolve = function(...args) {
                clearTimeout(timeoutId);
                originalResolve(...args);
            };
            
            reject = function(...args) {
                clearTimeout(timeoutId);
                originalReject(...args);
            };
            
        } catch (error) {
            console.error('âŒ åˆ›å»ºæµå¼è¿æ¥å¤±è´¥:', error);
            reject(error);
        }
    });
}

// å–æ¶ˆå½“å‰è¯·æ±‚
function cancelCurrentRequest() {
    if (currentEventSource) {
        console.log('å–æ¶ˆå½“å‰è¯·æ±‚...');
        currentEventSource.close();
        currentEventSource = null;
        
        hideTypingIndicator();
        addChatMessage('è¯·æ±‚å·²å–æ¶ˆã€‚', 'ai');
        showNotification('å·²å–æ¶ˆå½“å‰è¯·æ±‚', 'info');
    }
    
    resetInputState();
}

// é‡ç½®è¾“å…¥çŠ¶æ€
function resetInputState() {
    isProcessing = false;
    
    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    
    input.disabled = false;
    sendBtn.disabled = false;
    sendBtn.innerHTML = 'å‘é€';
    sendBtn.onclick = sendChatMessage;
    
    input.focus();
}

// åˆ›å»ºAIæ¶ˆæ¯å…ƒç´ 
function createAIMessageElement() {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'ai-message';
    messageDiv.innerHTML = `
        <div class="message-avatar ai-avatar">ğŸ¤–</div>
        <div class="message-bubble" id="streaming-content"></div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    return messageDiv;
}

// æ›´æ–°AIæ¶ˆæ¯å†…å®¹ï¼ˆä¼˜åŒ–æµå¼æ˜¾ç¤ºï¼‰
function updateAIMessageContent(messageElement, content) {
    const contentDiv = messageElement.querySelector('#streaming-content');
    if (contentDiv) {
        // ä½¿ç”¨innerHTMLæ¥æ”¯æŒæ¢è¡Œå’Œæ ¼å¼ï¼ŒåŒæ—¶æ·»åŠ æ‰“å­—å…‰æ ‡æ•ˆæœ
        contentDiv.innerHTML = content.replace(/\n/g, '<br>') + '<span class="typing-cursor">|</span>';
        
        // æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

// å®ŒæˆAIæ¶ˆæ¯æ˜¾ç¤ºï¼ˆç§»é™¤æ‰“å­—å…‰æ ‡ï¼‰
function finalizeAIMessage(messageElement) {
    const contentDiv = messageElement.querySelector('#streaming-content');
    if (contentDiv) {
        // ç§»é™¤æ‰“å­—å…‰æ ‡
        const content = contentDiv.innerHTML.replace(/<span class="typing-cursor">.*?<\/span>/g, '');
        contentDiv.innerHTML = content;
    }
}

// æ›´æ–°è¾“å…¥æŒ‡ç¤ºå™¨çŠ¶æ€
function updateTypingIndicator(statusMessage) {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        const existingStatus = typingIndicator.querySelector('.status-text');
        if (existingStatus) {
            existingStatus.textContent = statusMessage;
        } else {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status-text';
            statusDiv.style.fontSize = '11px';
            statusDiv.style.color = '#666';
            statusDiv.style.marginTop = '5px';
            statusDiv.textContent = statusMessage;
            typingIndicator.appendChild(statusDiv);
        }
    }
}

// æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥çš„æŒ‡ç¤ºå™¨ï¼ˆå¢å¼ºç‰ˆï¼‰
function showTypingIndicator() {
    hideTypingIndicator(); // å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æŒ‡ç¤ºå™¨
    
    const chatMessages = document.getElementById('chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'ai-message';
    typingDiv.innerHTML = `
        <div class="message-avatar ai-avatar">ğŸ¤–</div>
        <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
            <div class="status-text" style="font-size: 11px; color: #666; margin-top: 5px;">æ­£åœ¨å¤„ç†æ‚¨çš„é—®é¢˜...</div>
        </div>
    `;
    
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// é™çº§åˆ°ä¼ ç»ŸAPIçš„æ–¹æ³•ï¼ˆå¤‡ç”¨ï¼‰
async function sendTraditionalRequest(message) {
        const response = await fetch('/api/conversation/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                message: message
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('HTTPé”™è¯¯:', errorText);
        throw new Error(`ç½‘ç»œé”™è¯¯: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.status === 'success') {
            addChatMessage(data.response, 'ai');
        } else {
            addChatMessage(data.response || 'æŠ±æ­‰ï¼Œæˆ‘æ— æ³•å¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚', 'ai');
            if (data.error) {
                console.error('AIé”™è¯¯:', data.error);
        }
    }
}

// å¿«æ·é—®é¢˜ï¼ˆå¢å¼ºç‰ˆï¼‰
function askQuickQuestion(question) {
    document.getElementById('chat-input').value = question;
    sendChatMessage();
}

// å¿«é€Ÿæµ‹è¯•æŒ‰é’®
function quickTest(type) {
    const testQueries = {
        'stats': 'ç»Ÿè®¡',
        'today': 'ä»Šå¤©',
        'urgent': 'ç´§æ€¥',
        'processing': 'å¤„ç†ä¸­'
    };
    
    const query = testQueries[type] || 'ç»Ÿè®¡';
    askQuickQuestion(query);
}

// æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°ç•Œé¢ï¼ˆä¿æŒå…¼å®¹ï¼‰
function addChatMessage(message, sender) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    
    if (sender === 'user') {
        messageDiv.className = 'user-message';
        messageDiv.innerHTML = `
            <div class="message-avatar user-avatar">ğŸ‘¤</div>
            <div class="message-bubble">${escapeHtml(message)}</div>
        `;
    } else {
        messageDiv.className = 'ai-message';
        messageDiv.innerHTML = `
            <div class="message-avatar ai-avatar">ğŸ¤–</div>
            <div class="message-bubble">${message}</div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    
    // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// éšè—AIæ­£åœ¨è¾“å…¥çš„æŒ‡ç¤ºå™¨
function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// å¤„ç†é”®ç›˜äº‹ä»¶
function handleChatKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        if (!isProcessing) {
        sendChatMessage();
    }
}

    // ESCé”®å–æ¶ˆè¯·æ±‚
    if (event.key === 'Escape' && isProcessing) {
        cancelCurrentRequest();
    }
}

// æ¸…é™¤å¯¹è¯å†å²
async function clearChatHistory() {
    if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¯¹è¯è®°å½•å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch('/api/conversation/history/', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // æ¸…é™¤ç•Œé¢ä¸­çš„å¯¹è¯è®°å½•
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = `
                <div class="ai-message">
                    <div style="display: flex; align-items: flex-start; margin-bottom: 15px;">
                        <div style="background: #667eea; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 14px;">ğŸ¤–</div>
                        <div style="background: #f1f3f4; padding: 10px; border-radius: 10px; max-width: 80%; word-wrap: break-word;">
                            å¯¹è¯è®°å½•å·²æ¸…é™¤ï¼æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨æŸ¥è¯¢è®¢å•ä¿¡æ¯ã€‚è¯•è¯•è¯´ã€Œç»Ÿè®¡ã€æˆ–ã€Œä»Šå¤©ã€ï¼
                        </div>
                    </div>
                </div>
            `;
            
            showNotification('å¯¹è¯è®°å½•å·²æ¸…é™¤', 'success');
        } else {
            showNotification('æ¸…é™¤å¤±è´¥ï¼š' + data.message, 'error');
        }
        
    } catch (error) {
        console.error('æ¸…é™¤å¯¹è¯è®°å½•é”™è¯¯:', error);
        showNotification('æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
    }
}

// æµ‹è¯•å¯¹è¯API
async function testConversationAPI() {
    const debugInfo = document.getElementById('debug-info');
    
    function addDebugLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        debugInfo.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        debugInfo.scrollTop = debugInfo.scrollHeight;
    }
    
    addDebugLog('ğŸ”„ å¼€å§‹æµ‹è¯•å¯¹è¯API...');
    
    try {
        const response = await fetch('/api/conversation/test/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        addDebugLog(`ğŸ“Š å“åº”çŠ¶æ€: ${response.status}`);
        
        const data = await response.json();
        addDebugLog(`ğŸ“ æµ‹è¯•ç»“æœ: ${data.test_successful ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
        addDebugLog(`ğŸ’¬ æµ‹è¯•æ¶ˆæ¯: ${data.test_message}`);
        addDebugLog(`ğŸ¤– AIå›å¤: ${data.ai_response ? data.ai_response.slice(0, 50) + '...' : 'æ— '}`);
        
        if (data.test_successful) {
            addDebugLog('âœ… å¯¹è¯APIæµ‹è¯•æˆåŠŸï¼');
            showNotification('å¯¹è¯APIæµ‹è¯•æˆåŠŸ', 'success');
        } else {
            addDebugLog(`âŒ æµ‹è¯•å¤±è´¥: ${data.message}`);
            showNotification('å¯¹è¯APIæµ‹è¯•å¤±è´¥', 'error');
        }
        
    } catch (error) {
        addDebugLog(`ğŸ’¥ æµ‹è¯•å¤±è´¥: ${error.message}`);
        showNotification('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
    }
    
    addDebugLog('ğŸ æµ‹è¯•å®Œæˆ');
}

// æµ‹è¯•æµå¼API
async function testStreamingAPI() {
    const debugInfo = document.getElementById('debug-info');
    const sseStatus = document.getElementById('sse-status');
    const lastEvent = document.getElementById('last-event');
    const eventCount = document.getElementById('event-count');
    const currentStatus = document.getElementById('current-status');

    function addDebugLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        debugInfo.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        debugInfo.scrollTop = debugInfo.scrollHeight;
    }

    addDebugLog('ğŸ”„ å¼€å§‹æµ‹è¯•æµå¼API...');
    sseStatus.textContent = 'å°è¯•è¿æ¥...';
    lastEvent.textContent = 'æ— ';
    eventCount.textContent = '0';
    currentStatus.textContent = 'ç©ºé—²';

    try {
        const encodedMessage = encodeURIComponent('æµ‹è¯•æµå¼API');
        const sseUrl = `/api/conversation/stream/?message=${encodedMessage}`;
        const eventSource = new EventSource(sseUrl);
        currentEventSource = eventSource; // æ›´æ–°å…¨å±€å˜é‡

        eventSource.onopen = function(event) {
            addDebugLog('âœ… SSEè¿æ¥å·²å»ºç«‹');
            sseStatus.textContent = 'å·²è¿æ¥';
            currentStatus.textContent = 'å·²è¿æ¥';
        };

        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                addDebugLog(`ğŸ“¨ æ”¶åˆ°SSEæ•°æ®: ${event.data}`);
                lastEvent.textContent = event.data;
                eventCount.textContent = parseInt(eventCount.textContent) + 1;

                if (data.type === 'start') {
                    addDebugLog('ğŸš€ å¼€å§‹å¤„ç†');
                } else if (data.type === 'status') {
                    addDebugLog(`ğŸ“Š çŠ¶æ€æ›´æ–°: ${data.message}`);
                } else if (data.type === 'content') {
                    addDebugLog(`ğŸ“ å†…å®¹æ•°æ®: ${data.content}`);
                } else if (data.type === 'complete') {
                    addDebugLog('âœ… å›å¤å®Œæˆ');
                } else if (data.type === 'end') {
                    addDebugLog('ğŸ æµå¼å“åº”ç»“æŸ');
                } else if (data.type === 'error') {
                    addDebugLog(`âŒ AIé”™è¯¯: ${data.message}`);
                }
            } catch (parseError) {
                addDebugLog(`âŒ è§£æSSEæ•°æ®å¤±è´¥: ${parseError.message}, Raw data: ${event.data}`);
            }
        };

        eventSource.addEventListener('close', function(event) {
            addDebugLog('ğŸ”’ SSEè¿æ¥å…³é—­');
            eventSource.close();
            currentEventSource = null;
            sseStatus.textContent = 'å·²å…³é—­';
            currentStatus.textContent = 'å·²å…³é—­';
            eventCount.textContent = '0';
            lastEvent.textContent = 'æ— ';
        });

        eventSource.onerror = function(event) {
            addDebugLog(`âŒ SSEè¿æ¥é”™è¯¯: ${event}`);
            eventSource.close();
            currentEventSource = null;
            sseStatus.textContent = 'é”™è¯¯';
            currentStatus.textContent = 'é”™è¯¯';
            lastEvent.textContent = 'æ— ';
            eventCount.textContent = '0';
        };

        // æ¨¡æ‹Ÿä¸€ä¸ªæµå¼å“åº”
        setTimeout(() => {
            const message = 'è¿™æ˜¯ä¸€æ¡æµå¼å“åº”æ¶ˆæ¯ã€‚';
            const encodedMessage = encodeURIComponent(message);
            const sseUrl = `/api/conversation/stream/?message=${encodedMessage}`;
            const eventSource = new EventSource(sseUrl);
            currentEventSource = eventSource; // æ›´æ–°å…¨å±€å˜é‡

            eventSource.onopen = function(event) {
                addDebugLog('âœ… SSEè¿æ¥å·²å»ºç«‹ (æ¨¡æ‹Ÿ)');
                sseStatus.textContent = 'å·²è¿æ¥ (æ¨¡æ‹Ÿ)';
                currentStatus.textContent = 'å·²è¿æ¥ (æ¨¡æ‹Ÿ)';
            };

            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addDebugLog(`ğŸ“¨ æ”¶åˆ°SSEæ•°æ® (æ¨¡æ‹Ÿ): ${event.data}`);
                    lastEvent.textContent = event.data;
                    eventCount.textContent = parseInt(eventCount.textContent) + 1;

                    if (data.type === 'start') {
                        addDebugLog('ğŸš€ å¼€å§‹å¤„ç† (æ¨¡æ‹Ÿ)');
                    } else if (data.type === 'status') {
                        addDebugLog(`ğŸ“Š çŠ¶æ€æ›´æ–° (æ¨¡æ‹Ÿ): ${data.message}`);
                    } else if (data.type === 'content') {
                        addDebugLog(`ğŸ“ å†…å®¹æ•°æ® (æ¨¡æ‹Ÿ): ${data.content}`);
                    } else if (data.type === 'complete') {
                        addDebugLog('âœ… å›å¤å®Œæˆ (æ¨¡æ‹Ÿ)');
                    } else if (data.type === 'end') {
                        addDebugLog('ğŸ æµå¼å“åº”ç»“æŸ (æ¨¡æ‹Ÿ)');
                    } else if (data.type === 'error') {
                        addDebugLog(`âŒ AIé”™è¯¯ (æ¨¡æ‹Ÿ): ${data.message}`);
                    }
                } catch (parseError) {
                    addDebugLog(`âŒ è§£æSSEæ•°æ®å¤±è´¥ (æ¨¡æ‹Ÿ): ${parseError.message}, Raw data: ${event.data}`);
                }
            };

            eventSource.addEventListener('close', function(event) {
                addDebugLog('ğŸ”’ SSEè¿æ¥å…³é—­ (æ¨¡æ‹Ÿ)');
                eventSource.close();
                currentEventSource = null;
                sseStatus.textContent = 'å·²å…³é—­ (æ¨¡æ‹Ÿ)';
                currentStatus.textContent = 'å·²å…³é—­ (æ¨¡æ‹Ÿ)';
                eventCount.textContent = '0';
                lastEvent.textContent = 'æ— ';
            });

            eventSource.onerror = function(event) {
                addDebugLog(`âŒ SSEè¿æ¥é”™è¯¯ (æ¨¡æ‹Ÿ): ${event}`);
                eventSource.close();
                currentEventSource = null;
                sseStatus.textContent = 'é”™è¯¯ (æ¨¡æ‹Ÿ)';
                currentStatus.textContent = 'é”™è¯¯ (æ¨¡æ‹Ÿ)';
                lastEvent.textContent = 'æ— ';
                eventCount.textContent = '0';
            };

        }, 5000); // 5ç§’åæ¨¡æ‹Ÿæµå¼å“åº”

    } catch (error) {
        addDebugLog(`ğŸ’¥ è¯·æ±‚å¤±è´¥: ${error.message}`);
        showNotification('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
    }
    addDebugLog('ğŸ æµ‹è¯•å®Œæˆ');
}

// æ›´æ–°è¿æ¥çŠ¶æ€
function updateConnectionStatus(status, message, eventCount) {
    const sseStatus = document.getElementById('sse-status');
    const lastEvent = document.getElementById('last-event');
    const eventCountSpan = document.getElementById('event-count');
    const currentStatus = document.getElementById('current-status');

    sseStatus.textContent = status;
    lastEvent.textContent = message;
    eventCountSpan.textContent = eventCount;
    currentStatus.textContent = status;
}

// æ¸…é™¤è°ƒè¯•ä¿¡æ¯
function clearDebugInfo() {
    const debugInfo = document.getElementById('debug-info');
    debugInfo.innerHTML = '';
    updateConnectionStatus('æœªè¿æ¥', 'æ— ', 0);
    showNotification('è°ƒè¯•ä¿¡æ¯å·²æ¸…é™¤', 'info');
}

// HTMLè½¬ä¹‰å‡½æ•°
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// æ›´æ–°é¡µé¢åˆå§‹åŒ–å‡½æ•°
document.addEventListener('DOMContentLoaded', function() {
    console.log('AIåŠ©æ‰‹é¡µé¢åŠ è½½å®Œæˆ');
    
    // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨ç”Ÿæˆçš„æŠ¥å‘Š
    checkAutoReport();
    
    // èšç„¦åˆ°è¾“å…¥æ¡†
    document.getElementById('chat-input').focus();
    
    // æ·»åŠ æ¬¢è¿æç¤º
    setTimeout(() => {
        showNotification('ğŸ’¬ ç°åœ¨æ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢è®¢å•ä¿¡æ¯ï¼è¯•è¯•é—®æˆ‘ï¼š"ä»Šå¤©æœ‰å¤šå°‘ä¸ªæ–°è®¢å•ï¼Ÿ"', 'info');
    }, 2000);
});
</script>
{% endblock %} 