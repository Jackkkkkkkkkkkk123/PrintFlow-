{% extends 'mobile/base.html' %}
{% load static %}

{% block title %}è®¢å•åˆ—è¡¨ - åé¾™å°åŠ¡ç®¡ç†ç³»ç»Ÿ{% endblock %}
{% block header_title %}è®¢å•åˆ—è¡¨{% endblock %}

{% block content %}
<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ total_orders }}</div>
        <div class="stat-label">æ€»è®¢å•</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ pending_orders }}</div>
        <div class="stat-label">å¾…å¤„ç†</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ processing_orders }}</div>
        <div class="stat-label">å¤„ç†ä¸­</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ completed_orders }}</div>
        <div class="stat-label">å·²å®Œæˆ</div>
    </div>
</div>

<!-- è®¢å•åˆ—è¡¨ -->
<div class="card">
    <div class="card-title">æœ€æ–°è®¢å•</div>
    
    {% if orders %}
        {% for order in orders %}
        <div class="list-item" onclick="showOrderDetail({{ order.id }})">
            <div class="list-item-header">
                <div class="list-item-title">{{ order.product_name|default:"æœªå‘½åäº§å“" }}</div>
                <span class="status-badge status-{% if order.status == 1 %}pending{% elif order.status == 2 %}processing{% elif order.status == 3 %}completed{% endif %}">
                    {% if order.status == 1 %}å¾…å¤„ç†
                    {% elif order.status == 2 %}å¤„ç†ä¸­
                    {% elif order.status == 3 %}å·²å®Œæˆ
                    {% else %}æœªçŸ¥{% endif %}
                </span>
            </div>
            <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                è®¢å•å·ï¼š{{ order.order_no }} | å®¢æˆ·ï¼š{{ order.customer_name|default:"æœªçŸ¥" }}
            </div>
            <div style="font-size: 12px; color: #666;">
                æ•°é‡ï¼š{{ order.quantity|default:"-" }} | äº¤æœŸï¼š{% if order.delivery_date %}{{ order.delivery_date|date:"Y-m-d" }}{% else %}æœªè®¾ç½®{% endif %}
            </div>
        </div>
        {% endfor %}
        
        <!-- åˆ†é¡µ -->
        {% if orders.has_other_pages %}
        <div style="text-align: center; margin-top: 20px;">
            {% if orders.has_previous %}
                <a href="?page={{ orders.previous_page_number }}" class="btn btn-outline" style="margin-right: 10px;">ä¸Šä¸€é¡µ</a>
            {% endif %}
            
            <span style="margin: 0 10px; color: #666;">
                ç¬¬ {{ orders.number }} / {{ orders.paginator.num_pages }} é¡µ
            </span>
            
            {% if orders.has_next %}
                <a href="?page={{ orders.next_page_number }}" class="btn btn-outline" style="margin-left: 10px;">ä¸‹ä¸€é¡µ</a>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        <div class="loading">
            <div style="font-size: 16px; color: #666;">ğŸ“‹</div>
            <div>æš‚æ— è®¢å•æ•°æ®</div>
        </div>
    {% endif %}
</div>

<!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
<div style="text-align: center; margin-top: 20px;">
    <button class="btn btn-primary" onclick="refreshOrders()">ğŸ”„ åˆ·æ–°è®¢å•</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
// æ˜¾ç¤ºè®¢å•è¯¦æƒ…
function showOrderDetail(orderId) {
    window.location.href = `/mobile/orders/${orderId}/`;
}

// åˆ·æ–°è®¢å•åˆ—è¡¨
function refreshOrders() {
    showNotification('æ­£åœ¨åˆ·æ–°è®¢å•åˆ—è¡¨...', 'info');
    setTimeout(() => {
        location.reload();
    }, 500);
}

// åˆå§‹åŒ–é¡µé¢
document.addEventListener('DOMContentLoaded', function() {
    console.log('è®¢å•åˆ—è¡¨é¡µé¢åŠ è½½å®Œæˆ');
    
    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ WebSocketè¿æ¥æ¥å®æ—¶æ›´æ–°è®¢å•çŠ¶æ€
    initWebSocketConnection();
});

// åˆå§‹åŒ–WebSocketè¿æ¥
function initWebSocketConnection() {
    if (typeof WebSocket !== 'undefined') {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/notifications/`;
        
        const socket = new WebSocket(wsUrl);
        
        socket.onopen = function(event) {
            console.log('ğŸ“± æ‰‹æœºç«¯WebSocketè¿æ¥æˆåŠŸ');
            showNotification('å®æ—¶æ›´æ–°å·²è¿æ¥', 'success');
        };
        
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('ğŸ“± æ”¶åˆ°WebSocketæ¶ˆæ¯:', data);
            
            if (data.type === 'progress_notification' || data.type === 'dashboard_update') {
                showNotification('è®¢å•çŠ¶æ€å·²æ›´æ–°', 'info');
                // å»¶è¿Ÿåˆ·æ–°ï¼Œè®©ç”¨æˆ·çœ‹åˆ°é€šçŸ¥
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        };
        
        socket.onclose = function(event) {
            console.log('ğŸ“± WebSocketè¿æ¥å…³é—­');
            showNotification('å®æ—¶æ›´æ–°å·²æ–­å¼€', 'error');
        };
        
        socket.onerror = function(error) {
            console.error('ğŸ“± WebSocketé”™è¯¯:', error);
        };
    }
}
</script>
{% endblock %} 